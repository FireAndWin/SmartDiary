<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #addBtn {
            padding: 5vw;
        }
    </style>

    <!-- head 中 -->
    <link rel="stylesheet" href="file:///android_asset/weui/weui.min.css">
    <link rel="stylesheet" href="file:///android_asset/weui/jquery-weui.mini.css">
    <!-- body 最后 -->
    <script src="file:///android_asset/weui/jquery.min.js"></script>
    <script src="file:///android_asset/weui/jquery-weui.min.js"></script>

</head>

<body>


    <div id="divChoices" class="weui-cells">
    </div>
    <div id="addBtn">
        <a href="javascript:;" class="weui-btn weui-btn_primary">
            添加选项
        </a>
    </div>

    <div class="weui-cells__title">选择方式</div>
    <div class="weui-cells weui-cells_radio">
        <label class="weui-cell weui-check__label" for="rbtn1">
            <div class="weui-cell__bd">
                <p>单选 </p>
            </div>
            <div class="weui-cell__ft">
                <input type="radio" class="weui-check" name="radio1" id="rbtn1">
                <span class="weui-icon-checked"></span>
            </div>
        </label>
        <label class="weui-cell weui-check__label" for="rbtn2">

            <div class="weui-cell__bd">
                <p>多选</p>
            </div>
            <div class="weui-cell__ft">
                <input type="radio" name="radio1" class="weui-check" id="rbtn2" checked="checked">
                <span class="weui-icon-checked"></span>
            </div>
        </label>
    </div>


    <script>


        //===============先获取到安卓的格式对象========================
        let jsonFormat = window.androidObject.getAndroidFormat();
        console.log("初始收到的jsonFormat: '" + jsonFormat);
        console.log("初始收到的jsonFormat类型:", typeof jsonFormat);
        //let jsonFormat = "{\"choiceList\":[{\"key\":\"1619096245588\",\"textValue\":\"1\"},{\"key\":\"1619096251629\",\"textValue\":\"\"}],\"type\":\"checkbox\",\"id\":\"choiceTemplate\"}";
        //这里对获取到的格式字符串做个判断,如果格式json是空字符串,就转化为一个默认的格式字符串.
        if (jsonFormat === "") {
            defaultFormat = {
                choiceList: [
                    {
                        key: "1111",
                        textValue: "选项1(可重命名)"
                    },
                    {
                        key: "1112",
                        textValue: "选项2"
                    },
                    {
                        key: "113",
                        textValue: "选项3(可以继续添加选项)"
                    },
                ],
                type: "checkbox",
                id: "choiceTemplate",
            };
            jsonFormat = JSON.stringify(defaultFormat);
            console.log("因为jsonFormat原本为空,使用默认格式对象", jsonFormat);
        };

        // let formatObj = JSON.parse("'" + jsonFormat + "'");
        let formatObj = JSON.parse(jsonFormat);
        //console.log("formatObj解析结果", formatObj);
        console.log("formatObj是否为空", formatObj === null);


        //==============然后遍历choice中的选项,添加到div中================
        let initChoiceList = function () {
            let divChoices = document.getElementById("divChoices");
            divChoices.innerHTML = "";
            for (let indexList in formatObj.choiceList) {
                let choice = formatObj.choiceList[indexList];
                let keyChoice = choice.key;
                let textChoice = choice.textValue;
                console.log("ded", textChoice);

                //创建列表表格div
                let divCell = document.createElement("div");
                divCell.setAttribute("class", "weui-cell divCell");
                divCell.setAttribute("choiceKey", keyChoice);
                //添加内容
                divCell.innerHTML = `

            <div class="weui-cell__hd">
                <i class="weui-icon-download" id=`+ "movedown" + keyChoice + `></i>
            </div>
            <div class="weui-cell__bd">
                <input class="weui-input" id=`+ "input" + keyChoice + ` type="text" placeholder="请输入选项名称" value=` + textChoice + `>
            </div>
            <div class="weui-cell__ft">
                <a href="javascript:;"     id=` + "delete" + keyChoice + ` class="weui-btn  weui-btn_mini  weui-btn_warn">删除</a>
            </div>
            `;
                divChoices.appendChild(divCell);


                //获取到输入框和删除按钮,向下移动按钮
                let btnDelete = document.getElementById("delete" + keyChoice);
                let inputName = document.getElementById("input" + keyChoice);
                let btnMoveDown = document.getElementById("movedown" + keyChoice);
                //添加事件
                //删除
                btnDelete.onclick = function () {
                    divCell.parentNode.removeChild(divCell);
                    formatObj.choiceList.forEach(function (item, index, arr) {
                        if (item.key === keyChoice) {
                            arr.splice(index, 1);
                            //console.log(formatObj.choiceList);
                            //initChoiceList();
                        };
                    });
                }
                //重命名
                inputName.oninput = function () {
                    formatObj.choiceList.forEach(function (item, index, arr) {
                        if (item.key === keyChoice) {
                            formatObj.choiceList[index].textValue = inputName.value;
                        };
                    });
                    console.log(formatObj);
                }
                //向下移动
                btnMoveDown.onclick = function () {
                    let cells = divChoices.childNodes;
                    cells.forEach(function (item, index, arr) {
                        if (cells[index] === divCell) {
                            let next = (index + 1) % (cells.length);
                            formatObj.choiceList[index] = formatObj.choiceList.splice(next, 1, formatObj.choiceList[index])[0];
                            console.log(formatObj.choiceList);
                            initChoiceList();
                        };
                    });
                };
            }
        };
        initChoiceList();

        //=============="添加选项"按钮事件========
        let btnAdd = document.getElementById("addBtn");
        btnAdd.onclick = function () {
            let millisNow = "" + Date.now();
            let newChoice = {
                key: "" + millisNow,
                textValue: "",
            }
            formatObj.choiceList.push(newChoice);
            initChoiceList();
            document.getElementById("input" + millisNow).focus();
        };
        //============="选择方式"相关==============
        let rbtn1 = document.getElementById("rbtn1");
        let rbtn2 = document.getElementById("rbtn2");
        if (formatObj.type === "radio") {
            rbtn1.checked = true;
        }
        else {
            rbtn2.checked = true;
        }

        let changeType = function () {
            if (rbtn1.checked == true)
                formatObj.type = "radio";
            else
                formatObj.type = "checkbox";
            console.log(formatObj);
        }
        rbtn1.onclick = changeType;
        rbtn2.onclick = changeType;
        //==============拖拽改变顺序功能===========

        //==============给安卓提供的借口============
        window.getJsFormat = function () {
            return JSON.stringify(formatObj);
        };

        window.getjsonFormat = function () {
            return jsonFormat;
        };

    </script>

</body>

</html>